#!/bin/bash

# Usage: workspace-launch <workspace> <class> <trigger> <command> [args...]
# Launches a command and moves all matching windows to a workspace until ready.
# <trigger> can be:
#   - "title:<string>" : stops when a window of <class> has a title matching <string>
#   - A number         : stops after that many seconds
#
# Examples:
#   workspace-launch 4 steam "title:Steam" steam
#   workspace-launch 5 discord 20 discord

workspace=$1
class=$2
trigger=$3
shift 3

echo "[workspace-launch] Starting: $@"
echo "[workspace-launch] Workspace: $workspace | Class: $class | Trigger: $trigger"

"$@" & disown

# Wait for the first window to appear
echo "[workspace-launch] Waiting for first window (class: $class)..."
while ! hyprctl clients -j | grep -q "\"class\": \"$class\""; do
    sleep 0.5
done
echo "[workspace-launch] First window detected, moving loop started."

if [[ "$trigger" =~ ^[0-9]+$ ]]; then
    end=$((SECONDS + trigger))
    while [ $SECONDS -lt $end ]; do
        hyprctl dispatch movetoworkspacesilent "$workspace,class:^($class)$" 1>/dev/null 2>/dev/null
        echo "[workspace-launch] Moved (timeout: ${end}s remaining: $((end - SECONDS))s)"
        sleep 0.5
    done
elif [[ "$trigger" == title:* ]]; then
    title="${trigger#title:}"
    while ! hyprctl clients -j | grep -A5 "\"class\": \"$class\"" | grep -q "\"title\": \"$title\""; do
        hyprctl dispatch movetoworkspacesilent "$workspace,class:^($class)$" 1>/dev/null 2>/dev/null
        echo "[workspace-launch] Moved (waiting for title: '$title')"
        sleep 0.5
    done
    hyprctl dispatch movetoworkspacesilent "$workspace,class:^($class)$" 1>/dev/null 2>/dev/null
    echo "[workspace-launch] Title found, final move done. Exiting."
fi
